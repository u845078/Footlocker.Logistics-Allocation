@model StoreBTSDetailModel

@{
    ViewBag.Title = "BTS Group Details";
}

<h2>BTS Group Details for @Html.Raw(Model.header.DisplayName) </h2>

@if ((ViewData["message"] != null) && (ViewData["message"].ToString().Length > 0))
{ 
    @Html.Raw("<font color=\"Red\">" + ViewData["message"] + "</font><br>")
}

@if (Model.details.Count > 0)
{
@(Html.Telerik().Grid(Model.details)
        .Name("StoreBTSDetail")
        .Columns(columns =>
        {
            columns.Bound(o => o.Division);
            columns.Bound(o => o.League);
            columns.Bound(o => o.Store);
            columns.Bound(o => o.DBA);
            columns.Bound(o => o.Mall);
            columns.Bound(o => o.City);
            columns.Bound(o => o.State);
            columns.Command(commands =>
            {
                commands.Custom("ShowDetail")
                        .Text("History")
                        .DataRouteValues(route => { route.Add(o => o.Division).RouteKey("div"); route.Add(o => o.Store).RouteKey("store"); })
                        .Ajax(false)
                        .Action("ShowDetail", "StoreBTS");
                commands.Custom("Delete")
                        .Text("Delete")
                        .DataRouteValues(route => { route.Add(o => o.Division).RouteKey("div"); route.Add(o => o.Store).RouteKey("store"); })
                        .Ajax(false)
                        .Action("DeleteDetail", "StoreBTS").HtmlAttributes(new { onclick = "return confirm('Are you sure?');" });
            }).HtmlAttributes(new { style = "text-align: left" }).Width(200);
        })
        .ToolBar(toolbar =>
        {
            toolbar.Template(@<text>
                @Html.ActionLink(
                         "Export Grid",
                         "ExportDetailsGrid",
                         "StoreBTS",
                         new
                         {
                             filter = "__filterBy__"
                         },
                         new
                         {
                             @class = "t-button",
                             @onclick = "exportSelected()",
                             id = "ExportDetailsGrid"
                         }
                      )
                </text>);
        })
        .DataBinding(dataBinding =>
        {
            dataBinding.Ajax().Select("_RefreshGrid", "StoreBTS", new { groupID = ViewData["GroupID"] }).Enabled(true);
        })
        .Sortable()
        .Pageable()
        .Filterable()
) 
}
<br /><br />
<h2>Add Stores</h2>
@using (Html.BeginForm("AddDetail", "StoreBTS", FormMethod.Get))
{
    <fieldset>
    <legend>Individual Store</legend>
        @Html.Hidden("ID", ViewData["GroupID"])
        @Html.Hidden("Year", ViewData["Year"])
        @Html.TextBox("Store")
        <input type="submit" value="Add Store" class="t-button" />
    </fieldset>
}

@if (Model.CopyFrom.Count() > 0)
{
    using (Html.BeginForm("CopyStoreBTS", "StoreBTS", FormMethod.Get))
    {
    <fieldset>
        <legend>Import from a previous group</legend>
        @Html.Hidden("ID", ViewData["GroupID"])
        @Html.DropDownList("CopyFrom", new SelectList(Model.CopyFrom, "ID", "DisplayName"))
        <input type="submit" value="import stores from group" class="t-button" style="width:200px" />
    </fieldset>
    }
    
}
<fieldset>
    <legend>Upload Spreadsheet</legend>
    Spreadsheet columns should be Division and Store.<br /><br />
    @Html.ActionLink("Download Template", "ExcelTemplate", new { }, new { @class = "t-button" })<br /><br />

    @(Html.Telerik().Upload()
        .Name("attachments")
        .Multiple(true)
        .Async(async => async
            .Save("Save", "StoreBTS", new { groupID = ViewData["GroupID"] })
            .AutoUpload(false))
            .ShowFileList(true)
        .ClientEvents(events => events
            .OnError("onError")
            .OnSelect("onSelect")
                    .OnSuccess("onSuccess")
            )
        )
    <input type="submit" id="spreadsheet" name="create" value="Upload" class="t-button" style="width:150px; visibility: hidden;display:none;" />
    <br />
    <h4 id="message"></h4>
</fieldset>
     <script type="text/javascript">
         function exportSelected() {
             var grid = $('#StoreBTSDetail').data('tGrid');
             if (grid.filterBy === "") {
                 $('#ExportDetailsGrid').attr('href', function () {
                     return "/StoreBTS/ExportDetailsGrid?ID=" + $('#ID').val();
                 });
             } else {
                 $('#ExportDetailsGrid').attr('href', function () {
                     return "/StoreBTS/ExportDetailsGrid?filter=" + grid.filterBy + "&ID=" + $('#ID').val();
                 });
             }
         }

         function onSelect(e) {
             var files = e.files;
             if (files[0].extension != ".xls") {
                 alert("Document must be a spreadsheet with a xls extension. ");
                 e.preventDefault();
             }
             else {
                 document.getElementById('spreadsheet').style.visibility = 'visible';
             }
             $('#message').empty();
         }

         function onError(e) {
             var message = e.XMLHttpRequest.responseText;
             $('#message').empty().append("<font color='red'>" + message + "</font><br><a class='t-button' href='../BTSErrors'>Download Errors</a>");

             e.preventDefault();
         }

         function onSuccess(e) {
             var message = e.XMLHttpRequest.responseText;
             $('#message').empty().append("<font color='red'>Success</font>");

             e.preventDefault();

             var grid = $("#StoreSeason").data("tGrid");
             grid.ajaxRequest();
         }
    </script>
<br />
<fieldset>
    <legend> Unassigned Stores </legend>

@(Html.Telerik().Grid(Model.UnassignedStores)
        .Name("StoreGrid")
        .DataKeys(keys =>
        {
            keys.Add(p => p.Store).RouteKey("store");
            keys.Add(p => p.Division).RouteKey("div");
        })
        .Columns(columns =>
        {
            columns.Bound(o => o.Division);
            columns.Bound(o => o.Region);
            columns.Bound(o => o.League);
            columns.Bound(o => o.Store);
            columns.Bound(o => o.Mall);
            columns.Bound(o => o.State);
            columns.Bound(o => o.City);
            columns.Bound(o => o.DBA);
            columns.Command(commands => commands
           .Custom("Add")
           .Text("Add to this group")
           .Action("AddDetail", "StoreBTS"))
           .HtmlAttributes(new { style = "text-align: center" })
           .Width(200);

        })
        .DataBinding(dataBinding =>
        {
            dataBinding.Server();
        })
        .Scrollable(scrolling => scrolling.Enabled(false))
        .Sortable(sorting => sorting.Enabled(true))
        .Pageable(paging => paging.Enabled(true))
        .Filterable(filtering => filtering.Enabled(true))
        .Groupable(grouping => grouping.Enabled(false))
        .Footer(true)

)
</fieldset>
<br />

<div>
    @Html.ActionLink("Back to List", "Index", new { div = Model.division }, new { @class = "t-button" })
</div>
